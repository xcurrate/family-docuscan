<!DOCTYPE html>
<html lang="id">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>DocuScan Diagnosis</title>

    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.13/cropper.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2/dist/umd/supabase.min.js"></script>

    <style>
        /* CSS DASAR */
        :root { --bg: #121212; --surface: #1e1e1e; --primary: #4f46e5; --text: #fff; }
        body { margin: 0; background: var(--bg); color: var(--text); font-family: sans-serif; height: 100dvh; display: flex; flex-direction: column; overflow: hidden; }
        
        /* HEADER */
        header { background: var(--surface); padding: 15px; display: flex; align-items: center; justify-content: space-between; height: 60px; box-sizing: border-box; border-bottom: 1px solid #333; }
        h1 { margin: 0; font-size: 1.2rem; color: #a5b4fc; }
        
        /* VIEWS */
        main { flex: 1; position: relative; overflow: hidden; }
        .view { display: none; width: 100%; height: 100%; position: absolute; background: var(--bg); overflow-y: auto; flex-direction: column; }
        .view.active { display: flex; }

        /* HOME MENU */
        .menu-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 15px; padding: 20px; }
        .btn-card { 
            background: var(--surface); border: 1px solid #333; padding: 20px; border-radius: 12px;
            color: white; display: flex; flex-direction: column; align-items: center; gap: 10px; font-size: 0.9rem;
        }
        .btn-card:active { background: #333; transform: scale(0.98); }
        .btn-primary { background: var(--primary); border: none; grid-column: span 2; }
        
        /* CAMERA */
        #camera-view { background: black; }
        video { width: 100%; height: 100%; object-fit: cover; }
        .cam-controls { position: absolute; bottom: 0; width: 100%; padding: 20px; background: rgba(0,0,0,0.5); display: flex; justify-content: center; gap: 20px; }
        .shutter { width: 70px; height: 70px; border-radius: 50%; background: white; border: 4px solid #ccc; }

        /* EDITOR */
        .editor-layout { display: flex; flex-direction: column; height: 100%; }
        .canvas-box { flex: 1; background: #000; position: relative; display: flex; justify-content: center; align-items: center; }
        canvas, img { max-width: 100%; max-height: 100%; object-fit: contain; }
        
        .controls { background: var(--surface); padding: 20px; border-top: 1px solid #333; flex-shrink: 0; max-height: 45%; overflow-y: auto; }
        .row { display: flex; gap: 10px; margin-bottom: 10px; }
        input, select, button.btn-act { flex: 1; padding: 12px; border-radius: 8px; border: 1px solid #444; background: #222; color: white; }
        button.btn-act { background: #333; cursor: pointer; }
        button.btn-save { background: var(--primary); color: white; width: 100%; font-weight: bold; }

        /* DEBUG CONSOLE (Supaya Error Terlihat) */
        #debug-console {
            position: fixed; bottom: 0; left: 0; width: 100%; height: 100px;
            background: rgba(0,0,0,0.9); color: #0f0; font-family: monospace; font-size: 10px;
            overflow-y: scroll; padding: 5px; z-index: 9999; border-top: 2px solid #0f0;
            display: none; /* Default sembunyi, muncul kalau error */
        }
    </style>
</head>
<body>

    <header>
        <button onclick="goHome()" style="background:none;border:none;color:white;font-size:1.5rem;">üè†</button>
        <h1>DocuScan v3.1</h1>
        <button onclick="toggleConsole()" style="background:none;border:none;color:#555;font-size:0.8rem;">üêû</button>
    </header>

    <main>
        <div id="home-view" class="view active">
            <div style="padding:20px; text-align:center;">
                <h2>Menu Utama</h2>
                <p style="color:#888;">Siap memindai dokumen.</p>
            </div>
            <div class="menu-grid">
                <button onclick="startCamera()" class="btn-card btn-primary">
                    <span style="font-size:2rem">üì∏</span>
                    <span>Mulai Scan</span>
                </button>
                <button onclick="document.getElementById('file-input').click()" class="btn-card">
                    <span style="font-size:2rem">üìÅ</span>
                    <span>Upload File</span>
                    <input type="file" id="file-input" accept="image/*" hidden onchange="handleFile(this)">
                </button>
                <button onclick="alert('Versi Aplikasi: 3.1 Pro\nStatus: Aktif')" class="btn-card">
                    <span style="font-size:2rem">‚ÑπÔ∏è</span>
                    <span>Info App</span>
                </button>
            </div>
        </div>

        <div id="camera-view" class="view">
            <video id="video" autoplay playsinline muted></video>
            <div class="cam-controls">
                <button onclick="goHome()" style="padding:10px; border-radius:20px; border:none;">Batal</button>
                <button onclick="capturePhoto()" class="shutter"></button>
            </div>
        </div>

        <div id="editor-view" class="view">
            <div class="editor-layout">
                <div class="canvas-box">
                    <canvas id="canvas"></canvas>
                    <img id="crop-img" style="display:none;">
                    <button id="btn-crop" onclick="startCrop()" style="position:absolute; top:10px; right:10px; padding:8px; border-radius:20px; border:none; background:rgba(0,0,0,0.7); color:white;">‚úÇÔ∏è Crop</button>
                    <div id="crop-actions" style="position:absolute; bottom:10px; display:none; gap:10px;">
                        <button onclick="applyCrop()" style="padding:8px 15px; border-radius:20px; border:none; background:#22c55e; color:white;">‚úÖ OK</button>
                        <button onclick="cancelCrop()" style="padding:8px 15px; border-radius:20px; border:none; background:#ef4444; color:white;">‚ùå Batal</button>
                    </div>
                </div>
                
                <div class="controls">
                    <div class="row">
                        <button class="btn-act" onclick="applyFilter('original')">Asli</button>
                        <button class="btn-act" onclick="applyFilter('magic')">Magic</button>
                        <button class="btn-act" onclick="applyFilter('bw')">B&W</button>
                    </div>
                    <div class="row">
                        <input id="doc-name" placeholder="Nama Dokumen">
                    </div>
                    <div class="row">
                        <select id="doc-category">
                            <option>KTP</option><option>KK</option><option>Lainnya</option>
                        </select>
                    </div>
                    <div class="row">
                        <button class="btn-act" onclick="downloadJPG()">‚¨á JPG</button>
                        <button class="btn-act" onclick="downloadPDF()">‚¨á PDF</button>
                    </div>
                    <button class="btn-act btn-save" onclick="saveToCloud()">‚òÅÔ∏è Simpan Database</button>
                </div>
            </div>
        </div>
    </main>

    <div id="debug-console">CONSOLE LOG (Klik üêû di atas untuk tutup/buka)<br></div>

    <script>
        // --- 1. SYSTEM LOGGING (Supaya Error Muncul di Layar) ---
        const debugEl = document.getElementById('debug-console');
        function log(msg, type='info') {
            console.log(msg);
            const color = type === 'error' ? 'red' : '#0f0';
            debugEl.innerHTML += `<span style="color:${color}">> ${msg}</span><br>`;
            // Auto scroll ke bawah
            debugEl.scrollTop = debugEl.scrollHeight;
            if(type === 'error') debugEl.style.display = 'block'; // Munculkan console kalau error
        }

        window.onerror = function(msg, url, line) {
            log(`ERROR SYSTEM: ${msg} (Line ${line})`, 'error');
            alert(`TERJADI ERROR: ${msg}`);
            return false;
        };

        function toggleConsole() {
            debugEl.style.display = debugEl.style.display === 'none' ? 'block' : 'none';
        }

        log("Aplikasi dimulai...");

        // --- 2. SETUP VARIABEL ---
        let stream = null;
        let originalData = null;
        let cropper = null;
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d', { willReadFrequently: true });
        const imgForCrop = document.getElementById('crop-img');

        // --- 3. NAVIGASI ---
        function goHome() {
            stopCamera();
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById('home-view').classList.add('active');
        }

        function showView(id) {
            document.querySelectorAll('.view').forEach(v => v.classList.remove('active'));
            document.getElementById(id).classList.add('active');
        }

        // --- 4. KAMERA ---
        async function startCamera() {
            log("Mencoba buka kamera...");
            try {
                showView('camera-view');
                stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                log("Kamera berhasil dibuka.");
            } catch (err) {
                log("Kamera Belakang Gagal: " + err.message, 'error');
                // Coba fallback
                try {
                    stream = await navigator.mediaDevices.getUserMedia({ video: true });
                    video.srcObject = stream;
                    log("Fallback ke kamera default berhasil.");
                } catch(e) {
                    log("Semua kamera gagal: " + e.message, 'error');
                    alert("Gagal buka kamera. Cek izin browser.");
                    goHome();
                }
            }
        }

        function capturePhoto() {
            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0);
            stopCamera();
            openEditor();
        }

        function stopCamera() {
            if(stream) { stream.getTracks().forEach(t => t.stop()); stream = null; }
        }

        // --- 5. UPLOAD ---
        function handleFile(input) {
            const file = input.files[0];
            if(!file) return;
            log("File dipilih: " + file.name);
            const reader = new FileReader();
            reader.onload = (e) => {
                const img = new Image();
                img.onload = () => {
                    canvas.width = img.width;
                    canvas.height = img.height;
                    ctx.drawImage(img, 0, 0);
                    openEditor();
                };
                img.src = e.target.result;
            };
            reader.readAsDataURL(file);
        }

        // --- 6. EDITOR ---
        function openEditor() {
            originalData = ctx.getImageData(0,0, canvas.width, canvas.height);
            // Reset Crop UI
            if(cropper) { cropper.destroy(); cropper = null; }
            imgForCrop.style.display = 'none';
            canvas.style.display = 'block';
            document.getElementById('crop-actions').style.display = 'none';
            document.getElementById('btn-crop').style.display = 'block';
            showView('editor-view');
        }

        // --- 7. CROPPER ---
        function startCrop() {
            if(typeof Cropper === 'undefined') return alert("Library Crop belum siap/gagal load.");
            
            canvas.style.display = 'none';
            imgForCrop.style.display = 'block';
            imgForCrop.src = canvas.toDataURL();
            
            document.getElementById('btn-crop').style.display = 'none';
            document.getElementById('crop-actions').style.display = 'flex';

            cropper = new Cropper(imgForCrop, { viewMode: 1, autoCropArea: 0.8 });
        }

        function applyCrop() {
            const cropped = cropper.getCroppedCanvas();
            canvas.width = cropped.width;
            canvas.height = cropped.height;
            ctx.drawImage(cropped, 0, 0);
            originalData = ctx.getImageData(0,0, canvas.width, canvas.height);
            openEditor();
        }

        function cancelCrop() { openEditor(); }

        // --- 8. FILTER ---
        function applyFilter(type) {
            if(!originalData) return;
            ctx.putImageData(originalData, 0, 0);
            
            if(type === 'magic') {
                createImageBitmap(originalData).then(bmp => {
                    ctx.save();
                    ctx.filter = 'contrast(1.4) brightness(1.1) saturate(1.2)';
                    ctx.drawImage(bmp, 0, 0);
                    ctx.restore();
                });
            } else if(type === 'bw') {
                const d = ctx.getImageData(0,0,canvas.width,canvas.height);
                for(let i=0; i<d.data.length; i+=4) {
                    const gray = 0.299*d.data[i] + 0.587*d.data[i+1] + 0.114*d.data[i+2];
                    const val = gray < 128 ? 0 : 255;
                    d.data[i] = d.data[i+1] = d.data[i+2] = val;
                }
                ctx.putImageData(d, 0, 0);
            }
        }

        // --- 9. DOWNLOAD ---
        function downloadJPG() {
            const link = document.createElement('a');
            link.download = 'scan_' + Date.now() + '.jpg';
            link.href = canvas.toDataURL('image/jpeg', 0.8);
            link.click();
        }

        function downloadPDF() {
            if(typeof window.jspdf === 'undefined') return alert("Library PDF gagal load.");
            const { jsPDF } = window.jspdf;
            const pdf = new jsPDF();
            const img = canvas.toDataURL('image/jpeg', 0.8);
            const props = pdf.getImageProperties(img);
            const pdfW = 210; 
            const pdfH = (props.height * pdfW) / props.width;
            pdf.addImage(img, 'JPEG', 0, 0, pdfW, pdfH);
            pdf.save('scan.pdf');
        }

        // --- 10. CLOUD SAVE ---
        async function saveToCloud() {
            // KONFIGURASI SUPABASE (GANTI DISINI!)
            const URL = 'https://sbxtfqidotarniglzban.supabase.co'; 
            const KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6InNieHRmcWlkb3Rhcm5pZ2x6YmFuIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjgyMjgxODQsImV4cCI6MjA4MzgwNDE4NH0.MCiWNCcmQRBmAvAbsbcpdMbSOWAg7zPqJynpCLf1RKQ';

            if(URL.includes('GANTI')) return alert("Eits! Anda belum mengisi URL Supabase di dalam kode index.html");
            
            const name = document.getElementById('doc-name').value;
            if(!name) return alert("Isi nama dokumen dulu!");

            log("Memulai upload...");
            try {
                // Inisialisasi Supabase Disini (Biar kalau error di awal ga bikin macet app)
                if(typeof supabase === 'undefined' || !window.supabase) throw new Error("Library Supabase Error");
                
                const client = window.supabase.createClient(URL, KEY);
                
                canvas.toBlob(async (blob) => {
                    try {
                        const fileName = Date.now() + '.jpg';
                        // Upload
                        const { error: upErr } = await client.storage.from('scans').upload(fileName, blob);
                        if(upErr) throw upErr;
                        log("Upload file sukses.");

                        // Get URL
                        const { data } = client.storage.from('scans').getPublicUrl(fileName);
                        
                        // DB Insert
                        const { error: dbErr } = await client.from('documents').insert([{
                            name: name,
                            category: document.getElementById('doc-category').value,
                            image_url: data.publicUrl
                        }]);
                        if(dbErr) throw dbErr;

                        alert("Berhasil Simpan! ‚úÖ");
                        goHome();
                    } catch(err) {
                        log("Error saat proses upload/db: " + err.message, 'error');
                        alert("Gagal: " + err.message);
                    }
                }, 'image/jpeg', 0.7);

            } catch(e) {
                log("Koneksi Supabase Gagal: " + e.message, 'error');
                alert("Gagal koneksi database. Cek Console di bawah layar.");
            }
        }
    </script>
</body>
</html>
